// ==UserScript==
// @name         Rival Regions - Lister 2 CSV
// @namespace    http://tampermonkey.net/
// @version      0.2
// @description  Donator table to CSV
// @author       You
// @match        http://rivalregions.com
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    $( document ).ajaxComplete(function() {
        if (window.location.href.substring(window.location.href.indexOf("#")+1, window.location.href.indexOf("/", window.location.href.indexOf("#")+1)) != 'listed' && $( "#nyancat-donator" ).length){
            $( "#nyancat-donator" ).remove();
        }else if(window.location.href.substring(window.location.href.indexOf("#")+1, window.location.href.indexOf("/", window.location.href.indexOf("#")+1)) == 'listed' && !$( "#nyancat-donator" ).length){
            insertBanner();
        }
    });

    function insertBanner(){
        var pathname = window.location.href.substring(window.location.href.indexOf("#")+1, window.location.href.indexOf("/", window.location.href.indexOf("#")+1));
        if (pathname == 'listed' && !$( "#nyancat-donator" ).length){
         $("#header_slide_inner").before('<div id="nyancat-donator" style="width:750px;margin-top:25px;margin-left:auto;margin-right:auto;" class="ib tc"> <h1>Donator List to CSV (v0.1.0)</h1>'+
                                           '<div style="padding:10px;width:15%;display:inline-block;"><span class="button_red" id="buy-and-sell-btn">Execute</span></div>'+
                                           '<textarea id="nyancat-donatetext"/>'+
                                           '</div>');
            document.getElementById ("buy-and-sell-btn").addEventListener ("click", AllAutoClickButton , false);
        }
    }

    function arrayToCSV (twoDiArray) {
        var csvRows = [];
        for (var i = 0; i < twoDiArray.length; ++i) {
            for (var j = 0; j < twoDiArray[i].length; ++j) {
                twoDiArray[i][j] = '\"' + twoDiArray[i][j] + '\"';
            }
            csvRows.push(twoDiArray[i].join(',').replace(/\s/g, ""));
        }

        return csvRows.join('\r\n');
    }

    function AllAutoClickButton(){
        var data = Array();
        $("#table_list tr").each(function(i, v){
            data[i] = Array();
            $(this).children('td').each(function(ii, vv){
                data[i][ii] = $(this).text().replace("\t", "");
            });
            data[i][0] = $(this).children(":first").attr('action')
        });
        $('#nyancat-donatetext').val(arrayToCSV(data).replace(/[\t\n]+/g, ""));
    }

})();
